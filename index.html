<script>
  // Datum & Fokus
  window.addEventListener('load', function(){
    const sn = document.getElementById('serialNumber');
    if (sn) { sn.focus(); }
    const delivery = document.getElementById('deliveryDate');
    const today = new Date().toISOString().slice(0,10);
    if (delivery && !delivery.value) delivery.value = today;
  });

  // Signature Canvas
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');
  let drawing=false, lastX=0, lastY=0;
  function getXYFromEvent(e){
    const rect = canvas.getBoundingClientRect();
    if(e.touches && e.touches[0]) return {x:e.touches[0].clientX-rect.left,y:e.touches[0].clientY-rect.top};
    return {x:e.clientX-rect.left,y:e.clientY-rect.top};
  }
  ['mousedown','touchstart'].forEach(ev => canvas.addEventListener(ev,e=>{drawing=true; const p=getXYFromEvent(e); lastX=p.x; lastY=p.y; e.preventDefault();}));
  ['mousemove','touchmove'].forEach(ev => canvas.addEventListener(ev,e=>{if(!drawing)return; const p=getXYFromEvent(e); ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; e.preventDefault();}));
  ['mouseup','mouseout','touchend'].forEach(ev => canvas.addEventListener(ev,()=>{drawing=false;}));

  function clearSignature(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
  function isCanvasBlank(){ const blank=document.createElement('canvas'); blank.width=canvas.width; blank.height=canvas.height; return canvas.toDataURL()===blank.toDataURL(); }

  // Reset Form
  function resetForm(){
    document.getElementById('deliveryForm').reset();
    clearSignature();
    document.getElementById('serialsTable').querySelector('tbody').innerHTML='';
    const today = new Date().toISOString().slice(0,10);
    const delivery = document.getElementById('deliveryDate');
    if(delivery) delivery.value = today;
    setTimeout(()=>document.getElementById('serialNumber').focus(),50);
    updateSpotlight();
  }

  // CSV Import
  document.getElementById('csvFileInput').addEventListener('change', function(){
    const f=this.files && this.files[0];
    if(!f) return;
    const reader=new FileReader();
    reader.onload=function(e){ parseCsv(e.target.result); };
    reader.readAsText(f);
    this.value='';
  });

  function parseCsv(text){
    const lines=text.split(/\r?\n/);
    const tbody=document.getElementById('serialsTable').querySelector('tbody');
    tbody.innerHTML='';
    lines.forEach(line=>{
      if(!line) return;
      let serial=line.split(',')[0].trim();
      if(serial.startsWith('"') && serial.endsWith('"')) serial=serial.slice(1,-1);
      if(!serial) return;
      addSerialToTable(serial);
    });
    updateSpotlight();
  }

  // Seriennummer sofort hinzuf체gen, sobald Input ge채ndert
  const serialInput = document.getElementById('serialNumber');
  serialInput.addEventListener('input', function(){
    const val = serialInput.value.trim();
    if(val==='') return;
    addSerialToTable(val);
    serialInput.value='';
    updateSpotlight();
  });

  function addSerialToTable(serial){
    const tbody=document.getElementById('serialsTable').querySelector('tbody');
    // Doppeltes vermeiden
    const existing = Array.from(tbody.querySelectorAll('td')).map(td=>td.textContent);
    if(existing.includes(serial)) return;
    const tr=document.createElement('tr');
    const td=document.createElement('td'); td.textContent=serial; tr.appendChild(td);
    tr.addEventListener('click', ()=>{ serialInput.value=serial; serialInput.focus(); });
    tbody.appendChild(tr);
  }

  // Spotlight Update
  function updateSpotlight(){
    const serials=Array.from(document.querySelectorAll('#serialsTable tbody tr td')).map(td=>td.textContent.trim()).filter(Boolean);
    const recipient=document.getElementById('teacherName').value.trim();
    document.getElementById('spotlightText').textContent = serials.join(', ') + (recipient ? ', ' + recipient : '');
  }
  document.getElementById('teacherName').addEventListener('input', updateSpotlight);

  // Save PDF
  document.getElementById('savePdfBtn').addEventListener('click', async function(){
    const city=document.getElementById('city').value.trim();
    const sf=document.getElementById('schoolForm').value.trim();
    const sname=document.getElementById('schoolName').value.trim();
    const date=new Date().toISOString().slice(0,10);
    const safe=str=>str.toString().trim().replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-\.]/g,'');
    const suggestionBody=(city&&sf&&sname)?`${safe(city)}_${safe(sf)}_${safe(sname)}`:'Lieferschein';
    const suggestion=`${suggestionBody}_${date}`;
    let filename=prompt('Bitte Dateinamen eingeben (ohne .pdf):',suggestion);
    if(filename===null) return;
    filename=filename.trim()||'Lieferschein';
    const finalName=filename.endsWith('.pdf')?filename:(filename+'.pdf');

    if(!city||!sf||!sname){ if(!confirm('Stadt / Schulform / Schulname sind nicht vollst채ndig ausgef체llt. Trotzdem speichern?')) return; }
    const tbody=document.getElementById('serialsTable').querySelector('tbody');
    if(!tbody || !tbody.querySelector('tr')){ if(!confirm('Es sind keine Seriennummern vorhanden. Trotzdem speichern?')) return; }

    const element=document.getElementById('pdfRoot');
    const opt={ margin:[10,10,10,10], filename:finalName, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
    try{ await html2pdf().set(opt).from(element).save(); } catch(err){ alert('Fehler beim Erstellen des PDFs: '+(err?.message||err)); console.error(err); }
  });
</script>
