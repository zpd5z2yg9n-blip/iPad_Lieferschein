<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lieferschein - Schulger√§te</title>
<style>
  body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; max-width:920px; margin:18px auto; padding:18px; background:#f5f5f5; }
  .container { background:white; padding:24px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
  @media print { body{background:white;margin:0;padding:0} .container{box-shadow:none;padding:18px;max-width:100%} .no-print{display:none !important} canvas{border:none} input,textarea,select{border:none;border-bottom:1px solid #333;padding:5px 0} }
  .form-group{margin-bottom:16px}
  label{display:block;font-weight:600;margin-bottom:6px;color:#333}
  input,textarea,select{width:100%;padding:10px;border:2px solid #e9e9e9;border-radius:6px;box-sizing:border-box;font-size:14px}
  input:focus,textarea:focus,select:focus{outline:none;border-color:#007aff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .signature-container{border:2px dashed #007aff;padding:10px;border-radius:6px;background:#fafafa}
  canvas{width:100%;height:160px;border:1px solid #ddd;border-radius:6px;background:#fff;touch-action:none; display:block}
  .button-group{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{padding:10px 18px;border-radius:6px;border:none;cursor:pointer;font-weight:600}
  .btn-primary{background:#007aff;color:#fff}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-danger{background:#dc3545;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border:1px solid #ddd;text-align:left}
  tr:hover{background:#f1f7ff;cursor:pointer}
  .note { color:#666;font-size:13px;margin-top:4px; }
  .logo-placeholder { text-align:center; margin-bottom:10px; }
  /* Hidden Spotlight f√ºr Mac-Index */
  #spotlightText { display:none; }
</style>
</head>
<body>
<div class="container" id="pdfRoot">
  <form id="deliveryForm" onsubmit="return false;">
    <div class="grid">
      <div class="form-group">
        <label for="serialNumber">Seriennummer *</label>
        <input type="text" id="serialNumber" required placeholder="Barcode scannen oder eintippen">
      </div>
      <div class="form-group">
        <label for="teacherName">Name des Empf√§ngers *</label>
        <input type="text" id="teacherName" required placeholder="Vor- und Nachname">
      </div>
    </div>

    <div class="form-group">
      <label for="notes">Bemerkungen</label>
      <textarea id="notes" rows="3" placeholder="Zus√§tzliche Informationen, Sch√§den etc."></textarea>
    </div>

    <div class="form-group">
      <label>Unterschrift Schule *</label>
      <div class="signature-container">
        <canvas id="signatureCanvas" width="700" height="160"></canvas>
        <div class="button-group no-print">
          <button type="button" class="btn-danger" onclick="clearSignature()">Unterschrift l√∂schen</button>
        </div>
      </div>
    </div>

    <div class="button-group no-print">
      <button type="button" class="btn-primary" id="savePdfBtn">üíæ Als PDF speichern</button>
      <button type="button" class="btn-secondary" onclick="resetForm()">üîÑ Formular zur√ºcksetzen</button>
    </div>
  </form>

  <!-- Hidden f√ºr Mac Index / Spotlight -->
  <div id="spotlightText"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
window.addEventListener('load', function(){
  document.getElementById('serialNumber').focus();
});

// Signature Canvas
const canvas = document.getElementById('signatureCanvas');
const ctx = canvas.getContext('2d');
let drawing=false, lastX=0, lastY=0;

function getXYFromEvent(e){
  const rect = canvas.getBoundingClientRect();
  if (e.touches && e.touches[0]) return {x:e.touches[0].clientX - rect.left, y:e.touches[0].clientY - rect.top};
  return {x:e.clientX - rect.left, y:e.clientY - rect.top};
}

['mousedown','touchstart'].forEach(ev=>canvas.addEventListener(ev,e=>{
  drawing=true; const p=getXYFromEvent(e); lastX=p.x; lastY=p.y; e.preventDefault();
}));
['mousemove','touchmove'].forEach(ev=>canvas.addEventListener(ev,e=>{
  if(!drawing) return;
  const p=getXYFromEvent(e);
  ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke();
  lastX=p.x; lastY=p.y; e.preventDefault();
}));
['mouseup','mouseout','touchend'].forEach(ev=>canvas.addEventListener(ev,()=>{ drawing=false; }));

function clearSignature(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
function isCanvasBlank(){ const blank=document.createElement('canvas'); blank.width=canvas.width; blank.height=canvas.height; return canvas.toDataURL()===blank.toDataURL(); }

function resetForm(){
  document.getElementById('deliveryForm').reset();
  clearSignature();
  document.getElementById('serialNumber').focus();
  document.getElementById('spotlightText').textContent='';
}

// PDF Export
document.getElementById('savePdfBtn').addEventListener('click', async function(){
  const serial = document.getElementById('serialNumber').value.trim();
  const teacher = document.getElementById('teacherName').value.trim();
  const notes = document.getElementById('notes').value.trim();

  if(!serial || !teacher || isCanvasBlank()){ alert('Seriennummer, Empf√§nger und Unterschrift m√ºssen ausgef√ºllt sein!'); return; }

  // Hidden Spotlight f√ºr Mac
  document.getElementById('spotlightText').textContent = serial + ' | ' + teacher;

  const today = new Date().toISOString().slice(0,10);
  let filename = `Lieferschein_${today}.pdf`;

  const element = document.getElementById('pdfRoot');
  const opt = { margin:[10,10,10,10], filename:filename, image:{type:'jpeg', quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
  try{ await html2pdf().set(opt).from(element).save(); } catch(err){ alert('Fehler beim Erstellen des PDFs: '+(err.message||err)); console.error(err); }
});
</script>
</body>
</html>
