<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lieferschein - Schulger√§te</title>
<style>
  body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; max-width:920px; margin:18px auto; padding:18px; background:#f5f5f5; }
  .container { background:white; padding:24px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
  @media print { body{background:white;margin:0;padding:0} .container{box-shadow:none;padding:18px;max-width:100%} .no-print{display:none !important} canvas{border:none} input,textarea,select{border:none;border-bottom:1px solid #333;padding:5px 0} }
  .form-group{margin-bottom:16px}
  label{display:block;font-weight:600;margin-bottom:6px;color:#333}
  input,textarea,select{width:100%;padding:10px;border:2px solid #e9e9e9;border-radius:6px;box-sizing:border-box;font-size:14px}
  input:focus,textarea:focus,select:focus{outline:none;border-color:#007aff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .signature-container{border:2px dashed #007aff;padding:10px;border-radius:6px;background:#fafafa}
  canvas{width:100%;height:160px;border:1px solid #ddd;border-radius:6px;background:#fff;touch-action:none; display:block}
  .button-group{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{padding:10px 18px;border-radius:6px;border:none;cursor:pointer;font-weight:600}
  .btn-primary{background:#007aff;color:#fff}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-danger{background:#dc3545;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border:1px solid #ddd;text-align:left}
  tr:hover{background:#f1f7ff;cursor:pointer}
  .note { color:#666;font-size:13px;margin-top:4px; }
  .logo-placeholder { text-align:center; margin-bottom:10px; }

  /* Spotlight-Text ‚Äì unsichtbar f√ºr Nutzer, aber lesbar f√ºr Spotlight */
  #spotlightText {
    position: absolute;
    left: -9999px;
    top: -9999px;
    opacity: 0.01;
    color: transparent;
    white-space: pre-wrap;
  }
</style>
</head>
<body>
<div class="container" id="pdfRoot">
  <!-- LOGO HIER (optional) -->
  <form id="deliveryForm" onsubmit="return false;">
    <div class="grid">
      <div class="form-group">
        <label for="city">Stadt *</label>
        <select id="city" required>
          <option value="">Bitte Stadt w√§hlen</option>
          <option value="Neuss">Neuss</option>
          <option value="J√ºchen">J√ºchen</option>
          <option value="Grevenbroich">Grevenbroich</option>
          <option value="Kaarst">Kaarst</option>
          <option value="Meerbusch">Meerbusch</option>
        </select>
      </div>
      <div class="form-group">
        <label for="schoolForm">Schulform *</label>
        <select id="schoolForm" required>
          <option value="">Bitte ausw√§hlen</option>
          <option value="GS">GS</option>
          <option value="GY">GY</option>
          <option value="GE">GE</option>
          <option value="RS">RS</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="schoolName">Schulname *</label>
      <select id="schoolName" required>
        <option value="">Bitte Schule ausw√§hlen</option>
        <option value="Adolf-Clarenbach-Schule">Adolf-Clarenbach-Schule</option>
        <option value="Albert-Schweitzer-Schule">Albert-Schweitzer-Schule</option>
        <option value="Alexander-v.-Humboldt-Gymnasium">Alexander-v.-Humboldt-Gymnasium</option>
        <option value="Burgunderschule">Burgunderschule</option>
        <option value="Comenius-Schule">Comenius-Schule</option>
        <option value="Die Br√ºcke">Die Br√ºcke</option>
        <option value="Die Br√ºcke Dep">Die Br√ºcke Dep</option>
        <option value="Dreik√∂nigenschule">Dreik√∂nigenschule</option>
        <option value="Friedrich-von-Bodelschwingh-Schule">Friedrich-von-Bodelschwingh-Schule</option>
        <option value="Ganztagsrealschule Norf">Ganztagsrealschule Norf</option>
        <option value="Gebr√ºder-Grimm-Schule">Gebr√ºder-Grimm-Schule</option>
        <option value="Gesamtschule an der Erft">Gesamtschule an der Erft</option>
        <option value="Gesamtschule an der Erft Dep">Gesamtschule an der Erft Dep</option>
        <option value="Gesamtschule Nordstadt">Gesamtschule Nordstadt</option>
        <option value="Gesamtschule Nordstadt Dep">Gesamtschule Nordstadt Dep</option>
        <option value="Gesamtschule Norf">Gesamtschule Norf</option>
        <option value="Geschwister-Scholl-Grundschule">Geschwister-Scholl-Grundschule</option>
        <option value="G√∂rresschule">G√∂rresschule</option>
        <option value="Grundschule Allerheiligen">Grundschule Allerheiligen</option>
        <option value="Gymnasium Norf">Gymnasium Norf</option>
        <option value="Herbert-Karrenberg-Schule">Herbert-Karrenberg-Schule</option>
        <option value="Janusz-Korczak-Gesamtschule">Janusz-Korczak-Gesamtschule</option>
        <option value="Janusz-Korczak-Gesamtschule Dep">Janusz-Korczak-Gesamtschule Dep</option>
        <option value="Karl-Kreiner-Schule">Karl-Kreiner-Schule</option>
        <option value="Kreuzschule">Kreuzschule</option>
        <option value="Kyburg">Kyburg</option>
        <option value="Leoschule">Leoschule</option>
        <option value="Marie-Curie-Gymnasium">Marie-Curie-Gymnasium</option>
        <option value="Marie-Curie-Gymnasium Dep">Marie-Curie-Gymnasium Dep</option>
        <option value="Martin-Luther-Schule">Martin-Luther-Schule</option>
        <option value="Martinus-Schule Holzheim">Martinus-Schule Holzheim</option>
        <option value="Maximilian-Kolbe-Schule">Maximilian-Kolbe-Schule</option>
        <option value="M√ºnsterschule">M√ºnsterschule</option>
        <option value="Nelly-Sachs-Gymnasium">Nelly-Sachs-Gymnasium</option>
        <option value="Pestalozzischule">Pestalozzischule</option>
        <option value="Quirinus-Gymnasium">Quirinus-Gymnasium</option>
        <option value="Realschule Holzheim">Realschule Holzheim</option>
        <option value="Rita-S√ºssmuth-Realschule">Rita-S√ºssmuth-Realschule</option>
        <option value="Realschule S√ºdstadt">Realschule S√ºdstadt</option>
        <option value="Richard-Schirrman-Schule">Richard-Schirrman-Schule</option>
        <option value="Sekundarschule Neuss">Sekundarschule Neuss</option>
        <option value="St.-Andreas-Schule">St.-Andreas-Schule</option>
        <option value="St.-Hubertus-Schule">St.-Hubertus-Schule</option>
        <option value="St.-Konrad-Schule">St.-Konrad-Schule</option>
        <option value="St.-Martinus-Schule">St.-Martinus-Schule</option>
        <option value="St.-Stephanus-Schule">St.-Stephanus-Schule</option>
        <option value="St.Peter-Schule">St.Peter-Schule</option>
        <option value="Theodor-Schwann-Kolleg">Theodor-Schwann-Kolleg</option>
      </select>
    </div>

    <div class="grid">
      <div class="form-group">
        <label for="serialNumber">Seriennummer</label>
        <input type="text" id="serialNumber" placeholder="Barcode scannen oder eintippen">
        <div class="note">Fokus beim Laden aktiviert ‚Äî einfach scannen.</div>
      </div>
      <div class="form-group">
        <label for="deviceName">Ger√§tename</label>
        <input type="text" id="deviceName" placeholder="z. B. iPad Pro 11">
      </div>
    </div>

    <div class="grid">
      <div class="form-group">
        <label for="deliveryDate">Ausgabedatum</label>
        <input type="date" id="deliveryDate">
      </div>
      <div class="form-group">
        <label for="teacherName">Name des Empf√§ngers</label>
        <input type="text" id="teacherName" placeholder="Vor- und Nachname">
      </div>
    </div>

    <div class="form-group">
      <label for="schoolClass">Klasse / Abteilung</label>
      <input type="text" id="schoolClass" placeholder="z. B. 5a, Verwaltung">
    </div>

    <div class="form-group">
      <label for="notes">Bemerkungen</label>
      <textarea id="notes" rows="3" placeholder="Zus√§tzliche Informationen, Sch√§den etc."></textarea>
    </div>

    <div class="form-group">
      <label for="csvFileInput">Seriennummern per CSV hinzuf√ºgen (nur 1. Spalte wird verwendet)</label>
      <input type="file" id="csvFileInput" accept=".csv" class="no-print">
      <div class="note">CSV: jeweils eine Zeile, erste Spalte = Seriennummer. Kopfzeile ist optional.</div>
    </div>

    <div class="form-group">
      <h3>Seriennummern</h3>
      <table id="serialsTable">
        <thead><tr><th>Seriennummer</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="form-group">
      <label>Unterschrift Schule</label>
      <div class="signature-container">
        <canvas id="signatureCanvas" width="700" height="160"></canvas>
        <div class="button-group no-print" style="margin-top:8px">
          <button type="button" class="btn-danger" onclick="clearSignature()">Unterschrift l√∂schen</button>
        </div>
      </div>
    </div>

    <div class="button-group no-print" style="margin-top:12px">
      <button type="button" class="btn-primary" id="savePdfBtn">üíæ Als PDF speichern</button>
      <button type="button" class="btn-secondary" onclick="resetForm()">üîÑ Formular zur√ºcksetzen</button>
    </div>
  </form>
</div>

<!-- Unsichtbarer Bereich f√ºr Spotlight-Indexierung -->
<div id="spotlightText"></div>

<!-- html2pdf f√ºr clientseitiges PDF-Exportieren -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
  const spotlightDiv = document.getElementById('spotlightText');

  // Fokus & Datum setzen
  window.addEventListener('load', function(){
    const sn = document.getElementById('serialNumber');
    if (sn) { sn.focus(); }
    const delivery = document.getElementById('deliveryDate');
    const today = new Date().toISOString().slice(0,10);
    if (delivery && !delivery.value) delivery.value = today;
  });

  // Signature canvas
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');
  let drawing=false, lastX=0, lastY=0;
  function getXYFromEvent(e){
    const rect = canvas.getBoundingClientRect();
    if (e.touches && e.touches[0]) return {x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top};
    return {x: e.clientX - rect.left, y: e.clientY - rect.top};
  }
  canvas.addEventListener('mousedown', e=>{ drawing=true; const p=getXYFromEvent(e); lastX=p.x; lastY=p.y; });
  canvas.addEventListener('mousemove', e=>{ if(!drawing) return; const p=getXYFromEvent(e); ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; });
  canvas.addEventListener('mouseup', ()=>{ drawing=false; });
  canvas.addEventListener('mouseout', ()=>{ drawing=false; });
  canvas.addEventListener('touchstart', e=>{ e.preventDefault(); drawing=true; const p=getXYFromEvent(e); lastX=p.x; lastY=p.y; });
  canvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(!drawing) return; const p=getXYFromEvent(e); ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; });
  canvas.addEventListener('touchend', ()=>{ drawing=false; });

  function clearSignature(){ ctx.clearRect(0,0,canvas.width,canvas.height); }

  function isCanvasBlank(){
    const blank = document.createElement('canvas'); blank.width=canvas.width; blank.height=canvas.height;
    return canvas.toDataURL() === blank.toDataURL();
  }

  // Spotlight aktualisieren (Seriennummern + Empf√§nger)
  function updateSpotlightIndex() {
    const tbody = document.getElementById('serialsTable').querySelector('tbody');
    const recipient = (document.getElementById('teacherName').value || '').trim();
    spotlightDiv.textContent = '';
    tbody.querySelectorAll('tr td').forEach(td => { spotlightDiv.textContent += td.textContent + '\n'; });
    if (recipient) spotlightDiv.textContent += `Empf√§nger: ${recipient}\n`;
  }

  // Reset Form
  function resetForm(){
    document.getElementById('deliveryForm').reset();
    clearSignature();
    document.getElementById('serialsTable').querySelector('tbody').innerHTML = '';
    spotlightDiv.textContent = '';
    const today = new Date().toISOString().slice(0,10);
    const delivery = document.getElementById('deliveryDate');
    if (delivery) delivery.value = today;
    setTimeout(()=> document.getElementById('serialNumber').focus(), 50);
  }

  // CSV-Import
  document.getElementById('csvFileInput').addEventListener('change', function(){
    const f = this.files && this.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = function(e){ parseCsv(e.target.result); };
    reader.readAsText(f);
    this.value = '';
  });

  function parseCsv(text){
    const lines = text.split(/\r?\n/);
    const tbody = document.getElementById('serialsTable').querySelector('tbody');
    tbody.innerHTML = '';
    lines.forEach(line=>{
      if (!line) return;
      const cols = line.split(',');
      let serial = cols[0] ? cols[0].trim() : '';
      if (serial.startsWith('"') && serial.endsWith('"')) serial = serial.slice(1,-1);
      if (!serial) return;
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.textContent = serial;
      tr.appendChild(td);
      tr.addEventListener('click', ()=> {
        document.getElementById('serialNumber').value = serial;
        document.getElementById('serialNumber').focus();
        updateSpotlightIndex();
      });
      tbody.appendChild(tr);
    });
    updateSpotlightIndex();
  }

  // Empf√§nger-Feld √ºberwachen
  document.getElementById('teacherName').addEventListener('input', updateSpotlightIndex);

  // PDF speichern
  document.getElementById('savePdfBtn').addEventListener('click', async function(){
    const city = (document.getElementById('city').value || '').trim();
    const sf = (document.getElementById('schoolForm').value || '').trim();
    const sname = (document.getElementById('schoolName').value || '').trim();
    const date = new Date().toISOString().slice(0,10);
    const safe = str => (str || '').toString().trim().replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-\.]/g,'');
    const suggestionBody = (city && sf && sname) ? `${safe(city)}_${safe(sf)}_${safe(sname)}` : 'Lieferschein';
    const suggestion = `${suggestionBody}_${date}`;
    let filename = prompt('Bitte Dateinamen eingeben (ohne .pdf):', suggestion);
    if (filename === null) return;
    filename = filename.trim() || 'Lieferschein';
    const finalName = filename.endsWith('.pdf') ? filename : (filename + '.pdf');

    if (!city || !sf || !sname) {
      if (!confirm('Stadt / Schulform / Schulname sind nicht vollst√§ndig ausgef√ºllt. Trotzdem speichern?')) return;
    }
    const tbody = document.getElementById('serialsTable').querySelector('tbody');
    if (!tbody || !tbody.querySelector('tr')) {
      if (!confirm('Es sind keine Seriennummern vorhanden. Trotzdem speichern?')) return;
    }

    const element = document.getElementById('pdfRoot');
    const opt = {
      margin:       [10,10,10,10],
      filename:     finalName,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    try { await html2pdf().set(opt).from(element).save(); }
    catch (err) { alert('Fehler beim Erstellen des PDFs: ' + (err && err.message ? err.message : err)); console.error(err); }
  });
</script>
</body>
</html>
