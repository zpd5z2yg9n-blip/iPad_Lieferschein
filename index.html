<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lieferschein - Schulger√§te</title>
<style>
body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; max-width:920px; margin:18px auto; padding:18px; background:#f5f5f5; }
.container { background:white; padding:24px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
@media print { body{background:white;margin:0;padding:0} .container{box-shadow:none;padding:18px;max-width:100%} .no-print{display:none !important} canvas{border:none} input,textarea,select{border:none;border-bottom:1px solid #333;padding:5px 0} }
.form-group{margin-bottom:16px}
label{display:block;font-weight:600;margin-bottom:6px;color:#333}
input,textarea,select{width:100%;padding:10px;border:2px solid #e9e9e9;border-radius:6px;box-sizing:border-box;font-size:14px}
input:focus,textarea:focus,select:focus{outline:none;border-color:#007aff}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:640px){ .grid{grid-template-columns:1fr} }
.signature-container{border:2px dashed #007aff;padding:10px;border-radius:6px;background:#fafafa}
canvas{width:100%;height:160px;border:1px solid #ddd;border-radius:6px;background:#fff;touch-action:none; display:block}
.button-group{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
button{padding:10px 18px;border-radius:6px;border:none;cursor:pointer;font-weight:600}
.btn-primary{background:#007aff;color:#fff}
.btn-secondary{background:#6c757d;color:#fff}
.btn-danger{background:#dc3545;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{padding:8px;border:1px solid #ddd;text-align:left}
tr:hover{background:#f1f7ff;cursor:pointer}
.note { color:#666;font-size:13px;margin-top:4px; }
.logo-placeholder { text-align:center; margin-bottom:10px; }
</style>
</head>
<body>
<div class="container" id="pdfRoot">

<form id="deliveryForm" onsubmit="return false;">
  <!-- Stadt / Schulform -->
  <div class="grid">
    <div class="form-group">
      <label for="city">Stadt *</label>
      <select id="city" required>
        <option value="">Bitte Stadt w√§hlen</option>
        <option value="Neuss">Neuss</option>
        <option value="J√ºchen">J√ºchen</option>
        <option value="Grevenbroich">Grevenbroich</option>
        <option value="Kaarst">Kaarst</option>
        <option value="Meerbusch">Meerbusch</option>
      </select>
    </div>
    <div class="form-group">
      <label for="schoolForm">Schulform *</label>
      <select id="schoolForm" required>
        <option value="">Bitte ausw√§hlen</option>
        <option value="GS">GS</option>
        <option value="GY">GY</option>
        <option value="GE">GE</option>
        <option value="RS">RS</option>
      </select>
    </div>
  </div>

  <div class="form-group">
    <label for="schoolName">Schulname *</label>
    <select id="schoolName" required>
      <option value="">Bitte Schule ausw√§hlen</option>
      <option value="Adolf-Clarenbach-Schule">Adolf-Clarenbach-Schule</option>
      <option value="Albert-Schweitzer-Schule">Albert-Schweitzer-Schule</option>
      <option value="Alexander-v.-Humboldt-Gymnasium">Alexander-v.-Humboldt-Gymnasium</option>
      <option value="Burgunderschule">Burgunderschule</option>
      <option value="Comenius-Schule">Comenius-Schule</option>
      <option value="Die Br√ºcke">Die Br√ºcke</option>
      <option value="Dreik√∂nigenschule">Dreik√∂nigenschule</option>
      <option value="Friedrich-von-Bodelschwingh-Schule">Friedrich-von-Bodelschwingh-Schule</option>
      <option value="Gesamtschule an der Erft">Gesamtschule an der Erft</option>
      <option value="Gymnasium Norf">Gymnasium Norf</option>
      <!-- weitere Schulen hier erg√§nzen -->
    </select>
  </div>

  <!-- Ger√§tedaten / Seriennummer -->
  <div class="grid">
    <div class="form-group">
      <label for="serialNumber">Seriennummer *</label>
      <input type="text" id="serialNumber" placeholder="Barcode scannen oder eintippen">
      <div class="note">Fokus beim Laden aktiviert ‚Äî einfach scannen.</div>
    </div>
    <div class="form-group">
      <label for="deviceName">Ger√§tename</label>
      <input type="text" id="deviceName" placeholder="z. B. iPad Pro 11">
    </div>
  </div>

  <div class="grid">
    <div class="form-group">
      <label for="deliveryDate">Ausgabedatum</label>
      <input type="date" id="deliveryDate">
    </div>
    <div class="form-group">
      <label for="teacherName">Name des Empf√§ngers</label>
      <input type="text" id="teacherName" placeholder="Vor- und Nachname">
    </div>
  </div>

  <div class="form-group">
    <label for="schoolClass">Klasse / Abteilung</label>
    <input type="text" id="schoolClass" placeholder="z. B. 5a, Verwaltung">
  </div>

  <div class="form-group">
    <label for="notes">Bemerkungen</label>
    <textarea id="notes" rows="3" placeholder="Zus√§tzliche Informationen, Sch√§den etc."></textarea>
  </div>

  <!-- CSV Import -->
  <div class="form-group">
    <label for="csvFileInput">Seriennummern per CSV hinzuf√ºgen</label>
    <input type="file" id="csvFileInput" accept=".csv" class="no-print">
    <div class="note">CSV: Seriennummer, Ger√§tetyp, Sch√ºler, Klasse, Bemerkung. Kopfzeile optional.</div>
  </div>

  <div class="form-group">
    <h3>Ger√§te / Seriennummern</h3>
    <table id="serialsTable">
      <thead>
        <tr><th>Seriennummer</th><th>Ger√§tetyp</th><th>Sch√ºler</th><th>Klasse</th><th>Bemerkung</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="form-group">
    <label>Unterschrift Schule</label>
    <div class="signature-container">
      <canvas id="signatureCanvas" width="700" height="160"></canvas>
      <div class="button-group no-print" style="margin-top:8px">
        <button type="button" class="btn-danger" onclick="clearSignature()">Unterschrift l√∂schen</button>
      </div>
    </div>
  </div>

  <div class="button-group no-print" style="margin-top:12px">
    <button type="button" class="btn-primary" id="savePdfBtn">üíæ Als PDF speichern</button>
    <button type="button" class="btn-secondary" onclick="resetForm()">üîÑ Formular zur√ºcksetzen</button>
  </div>
</form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
// Fokus & Datum setzen
window.addEventListener('load', function(){
  const sn = document.getElementById('serialNumber');
  if(sn){ sn.focus(); sn.select(); }
  const delivery = document.getElementById('deliveryDate');
  const today = new Date().toISOString().slice(0,10);
  if(delivery && !delivery.value) delivery.value = today;
});

// Signature Canvas
const canvas = document.getElementById('signatureCanvas');
const ctx = canvas.getContext('2d');
let drawing=false, lastX=0, lastY=0;
function getXYFromEvent(e){
  const rect = canvas.getBoundingClientRect();
  if(e.touches && e.touches[0]) return {x:e.touches[0].clientX-rect.left, y:e.touches[0].clientY-rect.top};
  return {x:e.clientX-rect.left, y:e.clientY-rect.top};
}
canvas.addEventListener('mousedown', e=>{ drawing=true; const p=getXYFromEvent(e); lastX=p.x; lastY=p.y; });
canvas.addEventListener('mousemove', e=>{ if(!drawing) return; const p=getXYFromEvent(e); ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; });
canvas.addEventListener('mouseup', ()=>{ drawing=false; });
canvas.addEventListener('mouseout', ()=>{ drawing=false; });
canvas.addEventListener('touchstart', e=>{ e.preventDefault(); drawing=true; const p=getXYFromEvent(e); lastX=p.x; lastY=p.y; });
canvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(!drawing) return; const p=getXYFromEvent(e); ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; });
canvas.addEventListener('touchend', ()=>{ drawing=false; });
function clearSignature(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
function isCanvasBlank(){ const blank=document.createElement('canvas'); blank.width=canvas.width; blank.height=canvas.height; return canvas.toDataURL()===blank.toDataURL(); }
function resetForm(){
  document.getElementById('deliveryForm').reset();
  clearSignature();
  document.getElementById('serialsTable').querySelector('tbody').innerHTML='';
  const today = new Date().toISOString().slice(0,10);
  const delivery = document.getElementById('deliveryDate');
  if(delivery) delivery.value=today;
  setTimeout(()=>{ const sn=document.getElementById('serialNumber'); sn.focus(); sn.select(); },50);
}

// CSV Import: mehrere Spalten, alle Zeilen automatisch in Tabelle
document.getElementById('csvFileInput').addEventListener('change', function(){
  const f=this.files[0];
  if(!f) return;
  const reader=new FileReader();
  reader.onload=function(e){
    const lines=e.target.result.split(/\r?\n/);
    const tbody=document.getElementById('serialsTable').querySelector('tbody');
    tbody.innerHTML='';
    const snInput=document.getElementById('serialNumber');
    lines.forEach(line=>{
      if(!line.trim()) return;
      const cols=line.split(',');
      const serial=cols[0]?cols[0].trim().replace(/^"|"$/g,''):'';
      const deviceType=cols[1]?cols[1].trim():'';
      const student=cols[2]?cols[2].trim():'';
      const klass=cols[3]?cols[3].trim():'';
      const note=cols[4]?cols[4].trim():'';
      if(!serial) return;
      const tr=document.createElement('tr');
      [serial,deviceType,student,klass,note].forEach(v=>{ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
      tr.addEventListener('click', ()=>{ snInput.value=serial; snInput.focus(); snInput.select(); });
      tbody.appendChild(tr);
    });
    // Input-Feld immer bereit f√ºr neuen Scan
    snInput.focus(); snInput.select();
  };
  reader.readAsText(f);
  this.value='';
});

// PDF speichern
document.getElementById('savePdfBtn').addEventListener('click', async function(){
  const city=(document.getElementById('city').value||'').trim();
  const sf=(document.getElementById('schoolForm').value||'').trim();
  const sname=(document.getElementById('schoolName').value||'').trim();
  const date=new Date().toISOString().slice(0,10);
  const safe=str=> (str||'').toString().trim().replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-\.]/g,'');
  const suggestion=(city && sf && sname)?`${safe(city)}_${safe(sf)}_${safe(sname)}`:'Lieferschein';
  let filename=prompt('Bitte Dateinamen eingeben (ohne .pdf):',suggestion);
  if(filename===null) return;
  filename=filename.trim()||'Lieferschein';
  const finalName=filename.endsWith('.pdf')?filename:(filename+'.pdf');
  const tbody=document.getElementById('serialsTable').querySelector('tbody');
  if(!city || !sf || !sname){ if(!confirm('Stadt / Schulform / Schulname sind nicht vollst√§ndig ausgef√ºllt. Trotzdem speichern?')) return; }
  if(!tbody || !tbody.querySelector('tr')){ if(!confirm('Es sind keine Seriennummern vorhanden. Trotzdem speichern?')) return; }
  const element=document.getElementById('pdfRoot');
  const opt={
    margin:[10,10,10,10],
    filename:finalName,
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2,useCORS:true},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
  };
  try{ await html2pdf().set(opt).from(element).save(); } catch(err){ alert('Fehler beim Erstellen des PDFs: '+(err&&err.message?err.message:err)); console.error(err); }
});
</script>
</body>
</html>
