<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lieferschein - Schulger√§te</title>
<style>
:root {
  --bg-color: #f5f5f5;
  --container-bg: white;
  --primary-color: #0d5f8a;
  --accent-color: #007aff;
}

body { 
  font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; 
  max-width:920px; 
  margin:18px auto; 
  padding:18px; 
  background: var(--bg-color);
  /* Optional: Hintergrundbild - auskommentiert
  background-image: url('hintergrund.jpg');
  background-size: cover;
  background-attachment: fixed;
  */
}

.container { 
  background: var(--container-bg); 
  padding:24px; 
  border-radius:8px; 
  box-shadow:0 2px 10px rgba(0,0,0,0.08); 
}

.logo-container {
  text-align: center;
  margin-bottom: 20px;
  padding: 20px 0;
}

.logo-container img {
  max-width: 280px;
  height: auto;
  display: block;
  margin: 0 auto;
}

@media (max-width: 640px) {
  .logo-container img {
    max-width: 200px;
  }
}

.divider {
  height: 3px;
  background: var(--primary-color);
  margin: 20px 0 30px 0;
  border-radius: 2px;
}

/* KRITISCH f√ºr Spotlight: Alle Inhalte m√ºssen im Print sichtbar sein als TEXT */
@media print { 
  body{background:white;margin:0;padding:0} 
  .container{box-shadow:none;padding:18px;max-width:100%} 
  .no-print{display:none !important} 
  canvas{border:none}
  
  .logo-container {
    padding: 10px 0;
    margin-bottom: 15px;
  }
  
  .logo-container img {
    max-width: 200px;
  }
  
  /* Formularfelder als Text darstellen */
  input, textarea, select {
    border:none;
    border-bottom:1px solid #333;
    padding:5px 0;
    -webkit-appearance: none;
    background: transparent;
  }
  
  /* Tabelle gut sichtbar */
  table { page-break-inside: avoid; }
  th, td { border: 1px solid #333; }
}

.form-group{margin-bottom:16px}
label{display:block;font-weight:600;margin-bottom:6px;color:#333;font-size:14px}
input,textarea,select{
  width:100%;
  padding:10px;
  border:2px solid #e9e9e9;
  border-radius:6px;
  box-sizing:border-box;
  font-size:14px;
}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent-color)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:640px){ .grid{grid-template-columns:1fr} }
.signature-container{border:2px dashed var(--accent-color);padding:10px;border-radius:6px;background:#fafafa}
canvas{width:100%;height:160px;border:1px solid #ddd;border-radius:6px;background:#fff;touch-action:none; display:block}
.button-group{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
button{padding:10px 18px;border-radius:6px;border:none;cursor:pointer;font-weight:600}
.btn-primary{background:var(--accent-color);color:#fff}
.btn-secondary{background:#6c757d;color:#fff}
.btn-danger{background:#dc3545;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{padding:8px;border:1px solid #ddd;text-align:left;font-size:13px}
tbody tr:hover{background:#f1f7ff;cursor:pointer}
.note { color:#666;font-size:13px;margin-top:4px; }

/* Serial number field highlight */
#serialNumber {
  border: 2px solid var(--primary-color);
  background: #f0f8ff;
}
#serialNumber:focus {
  border-color: var(--accent-color);
  background: white;
  box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
}

/* Wichtig: Print-Werte sichtbar machen */
.print-value {
  display: none;
}
@media print {
  .print-value {
    display: inline;
    font-weight: normal;
  }
  /* Input-Felder ausblenden, stattdessen print-value anzeigen */
  input[type="text"],
  input[type="date"],
  textarea,
  select {
    display: none;
  }
  label {
    display: inline;
  }
  .form-group {
    margin-bottom: 10px;
  }
}

.info-banner {
  background: #e7f3ff;
  border-left: 4px solid var(--primary-color);
  padding: 12px 15px;
  margin: 15px 0;
  border-radius: 4px;
  font-size: 13px;
  color: #333;
}
</style>
</head>
<body>
<div class="container" id="pdfRoot">

<!-- Logo -->
<div class="logo-container">
  <img src="https://raw.githubusercontent.com/IHR-GITHUB-USERNAME/IHR-REPO-NAME/main/logo.png" alt="ITK Rheinland Logo" id="mainLogo">
</div>

<div class="divider"></div>

<div class="info-banner no-print">
  ‚ö° <strong>Schnelleingabe:</strong> Seriennummer scannen/eingeben ‚Üí Enter dr√ºcken ‚Üí automatisch zur Liste hinzugef√ºgt
</div>

<form id="deliveryForm" onsubmit="return false;">

<!-- Stadt / Schulform / Schule -->
<div class="grid">
  <div class="form-group">
    <label for="city">Stadt: <span class="print-value" id="print_city"></span></label>
    <select id="city" required>
      <option value="">Bitte Stadt w√§hlen</option>
      <option value="Neuss">Neuss</option>
      <option value="J√ºchen">J√ºchen</option>
      <option value="Grevenbroich">Grevenbroich</option>
      <option value="Kaarst">Kaarst</option>
      <option value="Meerbusch">Meerbusch</option>
    </select>
  </div>
  <div class="form-group">
    <label for="schoolForm">Schulform: <span class="print-value" id="print_schoolForm"></span></label>
    <select id="schoolForm" required>
      <option value="">Bitte ausw√§hlen</option>
      <option value="GS">GS</option>
      <option value="GY">GY</option>
      <option value="GE">GE</option>
      <option value="RS">RS</option>
    </select>
  </div>
</div>
<div class="form-group">
  <label for="schoolName">Schulname: <span class="print-value" id="print_schoolName"></span></label>
  <select id="schoolName" required>
    <option value="">Bitte Schule ausw√§hlen</option>
    <option value="Adolf-Clarenbach-Schule">Adolf-Clarenbach-Schule</option>
    <option value="Albert-Schweitzer-Schule">Albert-Schweitzer-Schule</option>
    <option value="Alexander-v.-Humboldt-Gymnasium">Alexander-v.-Humboldt-Gymnasium</option>
    <option value="Burgunderschule">Burgunderschule</option>
    <option value="Comenius-Schule">Comenius-Schule</option>
    <option value="Die Br√ºcke">Die Br√ºcke</option>
    <option value="Dreik√∂nigenschule">Dreik√∂nigenschule</option>
    <option value="Friedrich-von-Bodelschwingh-Schule">Friedrich-von-Bodelschwingh-Schule</option>
    <option value="Ganztagsrealschule Norf">Ganztagsrealschule Norf</option>
    <option value="Gebr√ºder-Grimm-Schule">Gebr√ºder-Grimm-Schule</option>
    <option value="Gesamtschule an der Erft">Gesamtschule an der Erft</option>
    <option value="Gesamtschule Nordstadt">Gesamtschule Nordstadt</option>
    <option value="Gesamtschule Norf">Gesamtschule Norf</option>
    <option value="Geschwister-Scholl-Grundschule">Geschwister-Scholl-Grundschule</option>
    <option value="G√∂rresschule">G√∂rresschule</option>
    <option value="Grundschule Allerheiligen">Grundschule Allerheiligen</option>
    <option value="Gymnasium Norf">Gymnasium Norf</option>
    <option value="Herbert-Karrenberg-Schule">Herbert-Karrenberg-Schule</option>
    <option value="Janusz-Korczak-Gesamtschule">Janusz-Korczak-Gesamtschule</option>
    <option value="Karl-Kreiner-Schule">Karl-Kreiner-Schule</option>
    <option value="Kreuzschule">Kreuzschule</option>
    <option value="Kyburg">Kyburg</option>
    <option value="Leoschule">Leoschule</option>
    <option value="Marie-Curie-Gymnasium">Marie-Curie-Gymnasium</option>
    <option value="Martin-Luther-Schule">Martin-Luther-Schule</option>
    <option value="Martinus-Schule Holzheim">Martinus-Schule Holzheim</option>
    <option value="Maximilian-Kolbe-Schule">Maximilian-Kolbe-Schule</option>
    <option value="M√ºnsterschule">M√ºnsterschule</option>
    <option value="Nelly-Sachs-Gymnasium">Nelly-Sachs-Gymnasium</option>
    <option value="Pestalozzischule">Pestalozzischule</option>
    <option value="Quirinus-Gymnasium">Quirinus-Gymnasium</option>
    <option value="Realschule Holzheim">Realschule Holzheim</option>
    <option value="Rita-S√ºssmuth-Realschule">Rita-S√ºssmuth-Realschule</option>
    <option value="Realschule S√ºdstadt">Realschule S√ºdstadt</option>
    <option value="Richard-Schirrman-Schule">Richard-Schirrman-Schule</option>
    <option value="Sekundarschule Neuss">Sekundarschule Neuss</option>
    <option value="St.-Andreas-Schule">St.-Andreas-Schule</option>
    <option value="St.-Hubertus-Schule">St.-Hubertus-Schule</option>
    <option value="St.-Konrad-Schule">St.-Konrad-Schule</option>
    <option value="St.-Martinus-Schule">St.-Martinus-Schule</option>
    <option value="St.-Stephanus-Schule">St.-Stephanus-Schule</option>
    <option value="St.Peter-Schule">St.Peter-Schule</option>
    <option value="Theodor-Schwann-Kolleg">Theodor-Schwann-Kolleg</option>
  </select>
</div>

<!-- Ger√§tedaten -->
<div class="grid">
  <div class="form-group">
    <label for="serialNumber">üîç Seriennummer (scannen oder eingeben + Enter): <span class="print-value" id="print_serialNumber"></span></label>
    <input type="text" id="serialNumber" placeholder="Barcode scannen oder eingeben, dann Enter">
    <div class="note no-print">Fokus aktiviert ‚Äî einfach scannen und Enter dr√ºcken!</div>
  </div>
  <div class="form-group">
    <label for="deviceName">Ger√§tename: <span class="print-value" id="print_deviceName"></span></label>
    <input type="text" id="deviceName" placeholder="z. B. iPad Pro 11">
  </div>
</div>
<div class="grid">
  <div class="form-group">
    <label for="deliveryDate">Ausgabedatum: <span class="print-value" id="print_deliveryDate"></span></label>
    <input type="date" id="deliveryDate">
  </div>
  <div class="form-group">
    <label for="teacherName">Name des Empf√§ngers / Abgeholt bei: <span class="print-value" id="print_teacherName"></span></label>
    <input type="text" id="teacherName" placeholder="Vor- und Nachname">
  </div>
</div>
<div class="form-group">
  <label for="schoolClass">Klasse / Abteilung: <span class="print-value" id="print_schoolClass"></span></label>
  <input type="text" id="schoolClass" placeholder="z. B. 5a, Verwaltung">
</div>
<div class="form-group">
  <label for="notes">Bemerkungen: <span class="print-value" id="print_notes"></span></label>
  <textarea id="notes" rows="3" placeholder="Zus√§tzliche Informationen, Sch√§den etc."></textarea>
</div>

<!-- Incidents Checker -->
<div class="form-group no-print" style="background:#fff3cd;padding:15px;border-radius:6px;border:2px solid #ffc107">
  <label for="incidentsFile" style="color:#856404">üîç Incidents-Checker (Excel/CSV)</label>
  <input type="file" id="incidentsFile" accept=".csv,.xlsx,.xls,text/csv,text/plain,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel">
  <div class="note" style="color:#856404">
    <strong>Incidents-Datei laden:</strong> Durchsucht Spalte "Seriennummer" und zeigt "Reference" an.<br>
    Unterst√ºtzt: CSV und Excel (.xlsx, .xls)
  </div>
  <div id="incidentsStatus" style="margin-top:8px;font-weight:600;color:#28a745"></div>
</div>

<!-- CSV Import -->
<div class="form-group no-print">
  <label for="csvFileInput">üìÑ CSV hinzuf√ºgen (Seriennummer, Ger√§tetyp, Sch√ºler, Klasse, Bemerkung)</label>
  <input type="file" id="csvFileInput" accept=".csv,text/csv,text/plain">
  <div class="note">CSV: erste Zeile optional. Mehrere Spalten m√∂glich.</div>
  <div class="note" style="color:#007aff;margin-top:8px">
    üí° <strong>iPad-Tipp:</strong> Wenn nicht alle CSV-Dateien sichtbar sind:<br>
    ‚Ä¢ Tippen Sie oben rechts auf "Durchsuchen"<br>
    ‚Ä¢ Navigieren Sie zum Nextcloud-Ordner<br>
    ‚Ä¢ Oder nutzen Sie "Zuletzt verwendet"
  </div>
</div>

<!-- Tabelle -->
<div class="form-group">
  <h3 style="margin-top:20px;margin-bottom:10px">üìã Ger√§te / Seriennummern</h3>
  <table id="serialsTable">
    <thead><tr><th>Seriennummer</th><th>Ger√§tetyp</th><th>Sch√ºler</th><th>Klasse</th><th>Bemerkung</th><th class="no-print">Aktion</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- Signature -->
<div class="form-group" style="margin-top:30px">
  <label>‚úçÔ∏è Unterschrift Schule</label>
  <div class="signature-container">
    <canvas id="signatureCanvas" width="700" height="160"></canvas>
    <div class="button-group no-print" style="margin-top:8px">
      <button type="button" class="btn-danger" onclick="clearSignature()">Unterschrift l√∂schen</button>
    </div>
  </div>
</div>

<div class="button-group no-print" style="margin-top:20px">
  <button type="button" class="btn-primary" onclick="printToPdf()" style="font-size:15px;padding:12px 24px">üñ®Ô∏è Als PDF speichern (durchsuchbar)</button>
  <button type="button" class="btn-secondary" onclick="resetForm()">üîÑ Formular zur√ºcksetzen</button>
</div>

</form>
</div>

<script>
// Fokus & Datum setzen
window.addEventListener('load', function(){
  const sn = document.getElementById('serialNumber'); 
  if(sn) sn.focus();
  const delivery = document.getElementById('deliveryDate');
  if(delivery && !delivery.value) delivery.value = new Date().toISOString().slice(0,10);
});

// Signature
const canvas = document.getElementById('signatureCanvas');
const ctx = canvas.getContext('2d');
let drawing=false, lastX=0, lastY=0;
function getXYFromEvent(e){
  const rect=canvas.getBoundingClientRect(); 
  if(e.touches && e.touches[0]) return {x:e.touches[0].clientX-rect.left, y:e.touches[0].clientY-rect.top}; 
  return {x:e.clientX-rect.left, y:e.clientY-rect.top};
}
canvas.addEventListener('mousedown', e=>{ drawing=true; const p=getXYFromEvent(e); lastX=p.x; lastY=p.y; });
canvas.addEventListener('mousemove', e=>{ if(!drawing) return; const p=getXYFromEvent(e); ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; });
canvas.addEventListener('mouseup', ()=>{ drawing=false; });
canvas.addEventListener('mouseout', ()=>{ drawing=false; });
canvas.addEventListener('touchstart', e=>{ e.preventDefault(); drawing=true; const p=getXYFromEvent(e); lastX=p.x; lastY=p.y; });
canvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(!drawing) return; const p=getXYFromEvent(e); ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; });
canvas.addEventListener('touchend', ()=>{ drawing=false; });
function clearSignature(){ ctx.clearRect(0,0,canvas.width,canvas.height); }

function isCanvasBlank(){ 
  const blank=document.createElement('canvas'); 
  blank.width=canvas.width; 
  blank.height=canvas.height; 
  return canvas.toDataURL()===blank.toDataURL(); 
}

function resetForm(){
  document.getElementById('deliveryForm').reset();
  clearSignature();
  document.getElementById('serialsTable').querySelector('tbody').innerHTML='';
  const today=new Date().toISOString().slice(0,10);
  const delivery=document.getElementById('deliveryDate'); 
  if(delivery) delivery.value=today;
  setTimeout(()=>document.getElementById('serialNumber').focus(),50);
}

// AUTOMATISCH Ger√§t zur Tabelle hinzuf√ºgen (Enter oder verlassen des Feldes)
function addDeviceToTable(){
  const serial = document.getElementById('serialNumber').value.trim();
  const deviceName = document.getElementById('deviceName').value.trim();
  const teacherName = document.getElementById('teacherName').value.trim();
  const schoolClass = document.getElementById('schoolClass').value.trim();
  const notes = document.getElementById('notes').value.trim();
  
  if(!serial){
    return; // Kein Alert, einfach nichts tun
  }
  
  const tbody = document.getElementById('serialsTable').querySelector('tbody');
  const tr = document.createElement('tr');
  
  [serial, deviceName, teacherName, schoolClass, notes].forEach(v => {
    const td = document.createElement('td');
    td.textContent = v;
    tr.appendChild(td);
  });
  
  // L√∂schen-Button
  const tdAction = document.createElement('td');
  tdAction.className = 'no-print';
  const btnDel = document.createElement('button');
  btnDel.textContent = 'üóëÔ∏è';
  btnDel.className = 'btn-danger';
  btnDel.style.padding = '4px 8px';
  btnDel.onclick = () => tr.remove();
  tdAction.appendChild(btnDel);
  tr.appendChild(tdAction);
  
  // Klick um Zeile zu bearbeiten
  tr.addEventListener('click', (e) => {
    if(e.target.tagName === 'BUTTON') return;
    document.getElementById('serialNumber').value = serial;
    document.getElementById('deviceName').value = deviceName;
    document.getElementById('teacherName').value = teacherName;
    document.getElementById('schoolClass').value = schoolClass;
    document.getElementById('notes').value = notes;
  });
  
  tbody.appendChild(tr);
  
  // Felder leeren
  document.getElementById('serialNumber').value = '';
  document.getElementById('deviceName').value = '';
  document.getElementById('notes').value = '';
  document.getElementById('serialNumber').focus();
}

// CSV Import
document.getElementById('csvFileInput').addEventListener('change', function(){
  const f = this.files && this.files[0]; 
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(e){ parseCsv(e.target.result); }
  reader.readAsText(f);
  this.value='';
});

function parseCsv(text){
  const lines = text.split(/\r?\n/);
  const tbody = document.getElementById('serialsTable').querySelector('tbody');
  
  lines.forEach(line => {
    if(!line.trim()) return;
    const cols = line.split(',');
    const serial = cols[0] ? cols[0].trim() : '';
    const type = cols[1] ? cols[1].trim() : '';
    const student = cols[2] ? cols[2].trim() : '';
    const klass = cols[3] ? cols[3].trim() : '';
    const note = cols[4] ? cols[4].trim() : '';
    
    if(!serial) return;
    
    const tr = document.createElement('tr');
    [serial, type, student, klass, note].forEach(v => {
      const td = document.createElement('td');
      td.textContent = v;
      tr.appendChild(td);
    });
    
    // L√∂schen-Button
    const tdAction = document.createElement('td');
    tdAction.className = 'no-print';
    const btnDel = document.createElement('button');
    btnDel.textContent = 'üóëÔ∏è';
    btnDel.className = 'btn-danger';
    btnDel.style.padding = '4px 8px';
    btnDel.onclick = () => tr.remove();
    tdAction.appendChild(btnDel);
    tr.appendChild(tdAction);
    
    tr.addEventListener('click', (e) => {
      if(e.target.tagName === 'BUTTON') return;
      document.getElementById('serialNumber').value = serial;
      document.getElementById('deviceName').value = type;
      document.getElementById('teacherName').value = student;
      document.getElementById('schoolClass').value = klass;
      document.getElementById('notes').value = note;
    });
    
    tbody.appendChild(tr);
  });
}

// KRITISCH: Werte vor Print in sichtbare Spans kopieren
function updatePrintValues(){
  const fields = ['city', 'schoolForm', 'schoolName', 'serialNumber', 'deviceName', 'deliveryDate', 'teacherName', 'schoolClass', 'notes'];
  fields.forEach(id => {
    const input = document.getElementById(id);
    const printSpan = document.getElementById('print_' + id);
    if(input && printSpan){
      const value = input.value || input.options?.[input.selectedIndex]?.text || '';
      printSpan.textContent = value;
    }
  });
}

// PDF Druck mit Browser-Funktion (wie alter Code)
function printToPdf(){
  const city = document.getElementById('city').value.trim();
  const sf = document.getElementById('schoolForm').value.trim();
  const sname = document.getElementById('schoolName').value.trim();
  
  if(!city || !sf || !sname){
    if(!confirm('Stadt/Schulform/Schulname nicht vollst√§ndig. Trotzdem speichern?')) return;
  }
  
  const tbody = document.getElementById('serialsTable').querySelector('tbody');
  if(!tbody || !tbody.querySelector('tr')){
    if(!confirm('Keine Seriennummern vorhanden. Trotzdem speichern?')) return;
  }
  
  if(isCanvasBlank()){
    if(!confirm('Keine Unterschrift vorhanden. Trotzdem speichern?')) return;
  }
  
  // Werte f√ºr Print-Ansicht kopieren
  updatePrintValues();
  
  // Dateiname vorschlagen via Browser-Dialog
  const date = new Date().toISOString().slice(0,10);
  const safe = str => str.toString().trim().replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-\.]/g,'');
  const suggestion = (city && sf && sname) ? `${safe(city)}_${safe(sf)}_${safe(sname)}_${date}` : `Lieferschein_${date}`;
  
  // Setze Dokumenttitel f√ºr PDF-Dateiname
  document.title = suggestion;
  
  // Browser-Druck-Dialog √∂ffnen
  window.print();
  
  // Titel zur√ºcksetzen
  setTimeout(() => {
    document.title = 'Lieferschein - Schulger√§te';
  }, 1000);
}

// Enter-Taste zum AUTOMATISCHEN Hinzuf√ºgen zur Liste
document.getElementById('serialNumber').addEventListener('keypress', function(e){
  if(e.key === 'Enter'){
    e.preventDefault();
    addDeviceToTable();
  }
});

// Auch bei Tab-Taste hinzuf√ºgen (optional)
document.getElementById('serialNumber').addEventListener('blur', function(){
  const serial = this.value.trim();
  if(serial && serial.length > 3){ // Nur wenn mind. 4 Zeichen
    // Check ob bereits in Tabelle
    const tbody = document.getElementById('serialsTable').querySelector('tbody');
    const existing = Array.from(tbody.querySelectorAll('tr')).find(row => 
      row.querySelector('td')?.textContent.trim() === serial
    );
    if(!existing){
      addDeviceToTable();
    }
  }
});
</script>
</body>
</html>
